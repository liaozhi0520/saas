{% extends 'web/layout/manage.html' %}
{% block title %}
    issue detail
{% endblock %}
{% block css %}
    <style>
        .sageGreen{
            background-color: #849376;
        }
        .sageGreen .modal-header{
            border-bottom: 2px solid black;
        }
        .sageGreen .modal-footer{
            border-top: 2px solid black;
        }
        .issueDetail{
            background-color: #849376;
        }
        .issueReplies{
            background-color: #849376;
        }
        .panel-body{
            border-top: 2px solid black;
        }
        .issueReply{
            background-color: #9fb287;
        }
        .issueReply>.panel-heading{
            padding: 10px 0;
            border-left: 0;
        }
        .issueReply>.panel-body{
            border-top: 1px solid black;
        }
        .panel-title .btn{
            background-color: #777777;
            color:#333333;
        }
    </style>
{% endblock %}
{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-12">
                <div class="panel  issueDetail">
                    <div class="panel-heading clearfix">
                      <h4 class="panel-title">
                        <a data-toggle="collapse"  href="#issueDetail" >
                          <i class="fa-solid fa-hand-point-right"></i>Issue Detail
                        </a>
                          <button type="button" class="btn btn-sm float-right" data-toggle="modal" data-target="#updateIssueDetailsModal">Modify</button>
                      </h4>
                    </div>
                    <div id="issueDetail" class="panel-collapse collapse in" >
                      <div class="panel-body">
                            <div class="row no-padding">
                                <div class="col-sm-12">
                                    <div class="col-xs-6">issue_creator</div>
                                    <div class="col-xs-6">issue_creating_time</div>
                                </div>
                                <div class="col-sm-12">
                                    <div class="col-xs-4">issue_status</div>
                                    <div class="col-xs-4">priviledge</div>
                                    <div class="col-xs-4">issue_type</div>
                                </div>
                                <div class="col-sm-12">Last_updated_time</div>
                                <div class="col-sm-6">issue_members</div>
                                <div class="col-sm-6">issue_Description</div>
                            </div>
                      </div>
                    </div>
                  </div>
            </div>
            <div class="col-sm-12">
                <div class="panel issueReplies">
                  <div class="panel-heading">
                    <div class="panel-title ">
                        Issue Replies
                        <button type="button" class="btn btn-sm propagateReplyId" data-toggle="modal" data-target="#createReplyModal">Reply</button>
                    </div>
                  </div>
                  <div class="panel-body">
                        <div class="panel issueReply hidden" id="issueReplyTpl" >
                            <div class="panel-heading">
                                <div class="panel-title">
                                    <a href="#replyFromUser1" data-toggle="collapse" class="reply_creator__username live-avatar"><span class="liveAvatar" data-toggle="tooltip" data-placement="bottom" title=""></span></a>
                                    <button type="button" class="btn btn-sm propagateReplyId" data-toggle="modal" data-target="#createReplyModal">Reply</button>
                                    <span class="reply_reply_time"> </span>
                                </div>
                            </div>
                            <div id="replyFromUser1"  class="panel-collapse collapse in">
                                <div class="panel-body">
                                    <p class="reply_content"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{#    modal of updating the issue details#}
    <div class="modal fade" id="updateIssueDetailsModal" tabindex="-1" >
        <div class="modal-dialog " >
            <div class="modal-content sageGreen">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal"><span >&times;</span></button>
                  <h4 class="modal-title" >Updating Your Issue Details</h4>
                </div>
                <div class="modal-body">
                    <form id="updateIssueDetailsForm" autocomplete="on">
                        {% csrf_token %}
                        fields of this form are the same as the creating form
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="triggerSubmissionUpdatingIssueDetailsForm">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="createReplyModal" tabindex="-1" >
        <div class="modal-dialog " >
            <div class="modal-content sageGreen">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal"><span >&times;</span></button>
                  <h4 class="modal-title" >Reply to someone</h4>
                </div>
                <div class="modal-body">
                    <form id="createReplyForm" autocomplete="on">
                        {% csrf_token %}
                        <input type="hidden" name="parent_reply_id">
                        <div class="form-group">
                            <label for="">Content</label>
                            <input type="textarea" class="form-control" rows="3" name="" id="" placeholder="Kind words warm the winter months, while the harsh words chill the summer season">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="triggerSubmissionCreatingReplyForm">Send</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block js %}
    <script>
        function bindButtonToFormSubmitAjax(buttonId,submitAJaxFunction) {
            $('#'+buttonId).on('click',function () {
                submitAJaxFunction()
            })
        }
        function updateIssueDetailFormSumbit() {
            var formData=$('#updateIssueDetailsForm').serialize()
            $.ajax({
                method: 'post',
                url:'',
                data:formData,
                dataType: 'json',
                success: function (response) {
                    if(response.flag){
                        location.reload()
                    }
                    else{
                        validationRes=response.content
                        $.each(validationRes,function (key,value) {
                            //show the error msg for each field
                        })
                    }
                },
                error: function (jqXHR,textErrorCode,ErrorThrown) {
                    alert('Error:'+jqXHR.textResponse+'('+textErrorCode+')')
                }
            })
        }
        function propagateReplyIdToReplyForm() {
            $('.propagateReplyId').on('click',function () {
                var parentReplyId=$(this).parent().parent().parent().attr('id')
                if (!parentReplyId){
                    parentReplyId='No Parent'
                }
                $('#createReplyForm').find('[name=parent_reply_id]').val(parentReplyId)
            })
        }
        function createReplyFormSubmit() {
            $.ajax({
                method:'post',
                url:'',
                data: $('#createReplyForm').serialize(),
                dataType:'json',
                success:function (response) {
                    if(response.flag){

                    }
                    else{
                        alert("Something went wrong.But don't fret, it's not your fault.")
                    }
                },
                error:function(jqXHR,textErrorCode,ErrorThrown){
                    alert('Error:'+jqXHR.textResponse+'('+textErrorCode+')')
                }
            })
        }
        function filloutReplyTpl(issueReply) {
            var issueReplyTplCloned=$('#issueReplyTpl').clone().attr('id','reply_'+issueReply.id).removeClass(['hidden'])
            issueReplyTplCloned.find('.reply_content').html(issueReply.content)
            issueReplyTplCloned.find('.reply_reply_time').html(issueReply.reply_time)
            const creatorName=issueReply.creator__username
            const FirstChar=creatorName.slice(0)
            issueReplyTplCloned.find('.reply_creator__username').find('.livaAvatar').html(FirstChar).attr('title',creatorName)
            return issueReplyTplCloned
        }
        function getIssueReplies(){
            $.ajax({
                method:'get',
                url:'',
                dataType:'json',
                success:function (response) {
                    if(response.flag){
                        IssueReplies=response.content
                        $.each(IssueReplies,function (index,issueReply) {
                            if(issueReply.parent_reply==null){
                                var issueReplyTplCloned=filloutReplyTpl(issueReply)
                                $('.issueReplies').find('panel-body').append(issueReplyTplCloned)
                            }
                            else{
                                var issueReplyTplCloned=filloutReplyTpl(issueReply)
                                $('.issueReplies').find('#issue_'+issueReply.parent_reply).find('panel-body').append(issueReplyTplCloned)
                                if(issueReply.has_next){
                                    $('#issue_'+issueReply.id).find('panel-body').append($('a').html('show more').addClass('retriveRepliesMoreThan2LevelAnchor'))
                                }
                            }
                        })
                    }
                    else{
                        //No replies
                    }
                },
                error:function (jqXHR,textStatus,errorThrown) {
                    alert('Error:'+jqXHR.textResponse+'('+textStatus+')')
                }
            })
        }
        $(function () {
            bindButtonToFormSubmitAjax('triggerSubmissionUpdatingIssueDetailsForm',updateIssueDetailFormSumbit)
            bindButtonToFormSubmitAjax('triggerSubmissionCreatingReplyForm',createReplyFormSubmit)
            getIssueReplies()
        })

    </script>
{% endblock %}